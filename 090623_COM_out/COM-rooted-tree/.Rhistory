D04seq1 <- prune_taxa(taxa_sums(D04seq)>0, D04seq)
# 3. CONVENTIONAL
K04seq<- subset_samples(aob.physeq_bulk1, Date=="04-28-22" & Treatment=="K")
K04seq1 <- prune_taxa(taxa_sums(K04seq)>0, K04seq)
# Date: 06-01-2022
# 1. MINERAL
M06seq<- subset_samples(aob.physeq_bulk1, Date=="06-01-22" & Treatment=="M")
M06seq1 <- prune_taxa(taxa_sums(M06seq)>0, M06seq)
# 2. BIODYNAMIC
D06seq<- subset_samples(aob.physeq_bulk1, Date=="06-01-22" & Treatment=="D")
D06seq1 <- prune_taxa(taxa_sums(D06seq)>0, D06seq)
# 3. CONVENTIONAL
K06seq<- subset_samples(aob.physeq_bulk1, Date=="06-01-22" & Treatment=="K")
K06seq1 <- prune_taxa(taxa_sums(K06seq)>0, K06seq)
# Date: 07-05-2022
# 1. MINERAL
M0705seq<- subset_samples(aob.physeq_bulk1, Date=="07-05-22" & Treatment=="M")
M0705seq1 <- prune_taxa(taxa_sums(M0705seq)>0, M0705seq)
# 2. BIODYNAMIC
D0705seq<- subset_samples(aob.physeq_bulk1, Date=="07-05-22" & Treatment=="D")
D0705seq1 <- prune_taxa(taxa_sums(D0705seq)>0, D0705seq)
# 3. CONVENTIONAL
K0705seq<- subset_samples(aob.physeq_bulk1, Date=="07-05-22" & Treatment=="K")
K0705seq1 <- prune_taxa(taxa_sums(K0705seq)>0, K0705seq)
# Date: 07-20-2022
# 1. MINERAL
M0720seq<- subset_samples(aob.physeq_bulk1, Date=="07-20-22" & Treatment=="M")
M0720seq1 <- prune_taxa(taxa_sums(M0720seq)>0, M0720seq)
# 2. BIODYNAMIC
D0720seq<- subset_samples(aob.physeq_bulk1, Date=="07-20-22" & Treatment=="D")
D0720seq1 <- prune_taxa(taxa_sums(D0720seq)>0, D0720seq)
# 3. CONVENTIONAL
K0720seq<- subset_samples(aob.physeq_bulk1, Date=="07-20-22" & Treatment=="K")
K0720seq1 <- prune_taxa(taxa_sums(K0720seq)>0, K0720seq)
# Date: 09-13-2022
# 1. MINERAL
M09seq<- subset_samples(aob.physeq_bulk1, Date=="09-13-22" & Treatment=="M")
M09seq1 <- prune_taxa(taxa_sums(M09seq)>0, M09seq)
# 2. BIODYNAMIC
D09seq<- subset_samples(aob.physeq_bulk1, Date=="09-13-22" & Treatment=="D")
D09seq1 <- prune_taxa(taxa_sums(D09seq)>0, D09seq)
# 3. CONVENTIONAL
K09seq<- subset_samples(aob.physeq_bulk1, Date=="09-13-22" & Treatment=="K")
K09seq1 <- prune_taxa(taxa_sums(K09seq)>0, K09seq)
library(glmmTMB)
library(emmeans)
tmp_T3s <- M04seq1
str(tmp_T3s)
i in 1:length(taxa_names(tmp_T3s)
length(taxa_names(tmp_T3s)
)
taxa_names(tmp_T3s)
tmp_T3s@otu_table[OTU,]@.Data
OTU = taxa_names(tmp_T3s)
OTU
y = as.vector(tmp_T3s@otu_table[OTU,]@.Data)
y
#  treatment
a = tibble("sample"= as.factor(tmp_T3s@sam_data$SampleID),
"treatment"= as.character(tmp_T3s@sam_data$Irrigation))
# force control as intercept
a[a == "Control"] <- "1a"
a = as.factor(a$treatment)
a
str(y)
tmp_T3s
otu_table(tmp_T3s)
d <- dietswap
data("dietswap", package = "microbiome")
d <- dietswap
View(d)
df <- data.frame(Abundance = abundances(d)[taxa,],
Group = meta(d)$nationality)
abundances(d)[taxa,]
data("dietswap", package = "microbiome")
dietswap
sample_data(dietswap)
taxa <- "Dialister"
taxa
d <- dietswap
df <- data.frame(Abundance = abundances(d)[taxa,],
Group = meta(d)$nationality)
df
M04_table
M04_table <- as.data.frame(otu_table(M04seq1))
M04_table
clr <- aldex.clr(M04_table, mc.samples = 128, verbose = F)
library(ALDEx2)
clr <- aldex.clr(M04_table, mc.samples = 128, verbose = F)
clr
cond.aldx <- sample_data(M04seq1)$Irrigation
cond.aldx
aldex.glm(clr, cond.aldx, useMC=FALSE)
conditions <- c(rep("N", 7), rep("S", 7))
conditions
aldex.glm(clr, useMC=FALSE)
aldex.glm(clr, useMC=FALSE)
clr <- aldex.clr(M04_table,cond.aldx, mc.samples = 128, verbose = F)
aldex.glm(clr, useMC=FALSE)
aldex.glm(clr,cond.aldx, useMC=FALSE)
covariates <- data.frame("A" = sample(0:1, 14, replace = TRUE),
"B" = c(rep(0, 7), rep(1, 7)))
covariates
# SET THE WORKING DIRECTORY
setwd('/Users/arifinabintarti/Documents/France/microservices/090623_COM_out/COM.ASV-analysis')
setwd('D:/Fina/INRAE_Project/microservices/090623_COM_out/COM.ASV-analysis')
wd <- print(getwd())
# load the asv table
com.asv <- read.table('annotated.COM.ASVs.counts.tsv', sep='\t', header=T, row.names = 1, check.names = FALSE)
dim(com.asv) # 686 192
# remove the bad sample (sample # 26) from the OTU table
com.asv.sub <- com.asv[, -which(names(com.asv) == "26" )]
sort(rowSums(com.asv.sub, na.rm = FALSE, dims = 1), decreasing = FALSE)
dim(com.asv.sub)
# load the taxonomy table
setwd('/Users/arifinabintarti/Documents/France/microservices/090623_COM_out/')
setwd('D:/Fina/INRAE_Project/microservices/090623_COM_out/')
com.tax <- read.table("besthit.diamond.output.curateddb.COM.ASVs.edited.csv", sep = ';', header=T)
dim(com.tax) # 680
# load the metadata
setwd('/Users/arifinabintarti/Documents/France/microservices/')
setwd('D:/Fina/INRAE_Project/microservices/')
meta_micro <- read.csv("meta_microservices.csv")
# remove the bad sample (sample # 26) from the metadata
meta_micro_sub <- meta_micro[-26,]
# load phylogenetic tree (nwk file)
setwd('D:/Fina/INRAE_Project/microservices/090623_COM_out/COM-rooted-tree/')
COM_rooted_tree <- ape::read.tree("tree.nwk")
############################################################################
# rarefaction curve
set.seed(13)
re_order <- match(rownames(meta_micro_sub), colnames(com.asv.sub))
com.asv.ord  <- com.asv.sub[ ,re_order]
com.asv.physeq = otu_table(com.asv.ord, taxa_are_rows = TRUE) # asv table
sample_names(com.asv.physeq)
# adding "S" for sample names to avoid possible problem later on
sample_names(com.asv.physeq) <- paste0("S", sample_names(com.asv.physeq))
# phyloseq object of the taxonomy table
com.tax <- column_to_rownames(com.tax, var = "ASVid")
#row.names(com.tax) <- com.tax$ASVid
com.tax.physeq = tax_table(as.matrix(com.tax)) # taxonomy table
# phyloseq object of the metadata
meta_micro_sub$Date <- factor(meta_micro_sub$Date, levels = c("4/28/22", "6/1/22", "7/5/22", "7/20/22", "9/13/22"),
labels = c("04-28-22", "06-01-22", "07-05-22", "07-20-22", "09-13-22"))
rownames(meta_micro_sub) <- sample_names(com.asv.physeq)
com.meta.physeq <- sample_data(meta_micro_sub)# meta data
sample_names(com.meta.physeq)
# read the rooted tree
setwd('D:/Fina/INRAE_Project/microservices/090623_COM_out/COM-rooted-tree/')
COM_rooted_tree <- ape::read.tree("tree.nwk")
# make phyloseq object
com.physeq <- merge_phyloseq(com.asv.physeq,com.tax.physeq,com.meta.physeq,COM_rooted_tree)
com.physeq # 653 taxa
sample_data(com.physeq)$SampleID <- paste0("S", sample_data(com.physeq)$SampleID)
sample_data(com.physeq)
# rarefy to minimum sequencing depth (minimum reads =  reads)
set.seed(333)
com.rare.min.physeq <- rarefy_even_depth(com.physeq, sample.size = 5242,
rngseed = 333, replace = FALSE, trimOTUs = TRUE, verbose = TRUE)
com.rare.min.physeq #632 taxa
sort(sample_sums(com.rare.min.physeq), decreasing = F) # 21 OTUs were removed because they are no longer present in any sample after random subsampling
#install.packages("colorBlindness")
library(colorBlindness)
displayAvailablePalette(color="white")
SteppedSequential5Steps
str(aoa.sp.df)
#install.packages("ggh4x")
library(ggh4x)
#########################################################################################
# COMAMMOX Community Composition
########################################################################################
# Phyloseq object of rarefied data and unrarefied data:
# 1. rarefied data
com.rare.min.physeq
tax_table(com.rare.min.physeq)
# merge taxa by species
com.sp <- tax_glom(com.rare.min.physeq, taxrank = "Species", NArm = F)
com.sp
clade <- c('Clade A','Clade B')
library(forcats)
library(dplyr)
com.sp.ra <- transform_sample_counts(com.sp, function(x) x/sum(x))
sample_data(com.sp.ra)
com.sp.df <- psmelt(com.sp.ra) %>%
group_by(var2, Type, Date, Treatment, Irrigation, Species) %>%
summarize(Mean = mean(Abundance)) %>%
arrange(-Mean)
com.sp.df$Type <- factor(com.sp.df$Type, levels = c("BS", "RS"),
labels = c("Bulk Soil", "Rhizosphere"))
com.sp.df$Treatment <- factor(com.sp.df$Treatment, levels = c("D", "K", "M"),
labels = c("Biodynamic", "Conventional", "Mineral"))
# merge taxa by species
com.sp <- tax_glom(com.rare.min.physeq, taxrank = "Species", NArm = F)
com.sp.ra <- transform_sample_counts(com.sp, function(x) x/sum(x))
sample_data(com.sp.ra)
com.sp.df <- psmelt(com.sp.ra) %>%
group_by(var2, Type, Date, Treatment, Irrigation, Species) %>%
summarize(Mean = mean(Abundance)) %>%
arrange(-Mean)
#install.packages("colorBlindness")
library(colorBlindness)
com.sp.df$Type <- factor(com.sp.df$Type, levels = c("BS", "RS"),
labels = c("Bulk Soil", "Rhizosphere"))
View(com.sp.df)
# merge taxa by species
com.sp <- tax_glom(com.rare.min.physeq, taxrank = "Species", NArm = F)
com.sp
com.sp.ra <- transform_sample_counts(com.sp, function(x) x/sum(x))
com.sp.ra
sample_data(com.sp.ra)
com.sp.df <- psmelt(com.sp.ra) %>%
group_by(var2, Type, Date, Treatment, Irrigation, Species) %>%
summarize(Mean = mean(Abundance)) %>%
arrange(-Mean)
com.sp.df
detach(package:plyr)
com.sp.df <- psmelt(com.sp.ra) %>%
group_by(var2, Type, Date, Treatment, Irrigation, Species) %>%
summarize(Mean = mean(Abundance)) %>%
arrange(-Mean)
View(com.sp.df)
com.sp.df <- psmelt(com.sp.ra) %>%
group_by(var2, Type, Date, Treatment, Irrigation, Clade, Species) %>%
summarize(Mean = mean(Abundance)) %>%
arrange(-Mean)
com.sp.df$Type <- factor(com.sp.df$Type, levels = c("BS", "RS"),
labels = c("Bulk Soil", "Rhizosphere"))
com.sp.df$Treatment <- factor(com.sp.df$Treatment, levels = c("D", "K", "M"),
labels = c("Biodynamic", "Conventional", "Mineral"))
legend <- "Comammox Taxa"
library(scales)
#x_cols <- rep(hue_pal()(length(unique(interaction(aob.sp.df$Date, aob.sp.df$Irrigation)))))
#aob.sp.df$Date <- factor(aob.sp.df$Date, levels = unique(aob.sp.df$Date))
com.sp.plot <- ggplot(com.sp.df, aes(x=interaction(Date, Irrigation), y=Mean, fill=Species)) +
geom_bar(aes(), stat="identity", position="fill") +
scale_fill_manual(legend, values=SteppedSequential5Steps)+
facet_nested(~Type+Treatment, nest_line = element_line(linetype = 1), scales="free")+
theme(legend.direction = "vertical",legend.position="right") +
guides(fill=guide_legend(ncol=1))+
labs(y= "Mean Relative Abundance")+
theme(plot.title = element_text(size = rel(1.5), face="bold"),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text=element_text(size=13, face = "bold"),
axis.line.x = element_blank(),
axis.text.x = element_text(angle = 90, hjust = 0.5, vjust=0.5),
#axis.ticks.x = element_blank(),
axis.title.x = element_blank(),
axis.title =element_text(size=15,face="bold"),
legend.text=element_text(size = 12),
legend.title = element_text(size=13, face = "bold"),
panel.grid = element_blank(),
panel.background = element_blank(),
strip.background = element_blank(),
strip.text.x = element_text(size = 14, face = "bold"),
panel.border = element_rect(colour = "black", fill = NA,linewidth= 0.2))+
scale_y_continuous(expand = c(0,0))+ guides(x="axis_nested")
com.sp.plot
# merge taxa by species
com.sp <- tax_glom(com.rare.min.physeq, taxrank = "Clade", NArm = F)
com.sp.ra <- transform_sample_counts(com.sp, function(x) x/sum(x))
sample_data(com.sp.ra)
#detach(package:plyr)
com.sp.df <- psmelt(com.sp.ra) %>%
group_by(var2, Type, Date, Treatment, Irrigation, Clade, Species) %>%
summarize(Mean = mean(Abundance)) %>%
arrange(-Mean)
sample_data(com.sp.ra)
#detach(package:plyr)
com.sp.df <- psmelt(com.sp.ra) %>%
group_by(var2, Type, Date, Treatment, Irrigation, Clade, Species) %>%
summarize(Mean = mean(Abundance)) %>%
arrange(-Mean)
#detach(package:plyr)
com.sp.df <- psmelt(com.sp.ra) %>%
group_by(var2, Type, Date, Treatment, Irrigation, Clade) %>%
summarize(Mean = mean(Abundance)) %>%
arrange(-Mean)
com.sp.df$Type <- factor(com.sp.df$Type, levels = c("BS", "RS"),
labels = c("Bulk Soil", "Rhizosphere"))
com.sp.df$Treatment <- factor(com.sp.df$Treatment, levels = c("D", "K", "M"),
labels = c("Biodynamic", "Conventional", "Mineral"))
#x_cols <- rep(hue_pal()(length(unique(interaction(aob.sp.df$Date, aob.sp.df$Irrigation)))))
#aob.sp.df$Date <- factor(aob.sp.df$Date, levels = unique(aob.sp.df$Date))
com.sp.plot <- ggplot(com.sp.df, aes(x=interaction(Date, Irrigation), y=Mean, fill=Clade)) +
geom_bar(aes(), stat="identity", position="fill") +
scale_fill_manual(legend, values=SteppedSequential5Steps)+
facet_nested(~Type+Treatment, nest_line = element_line(linetype = 1), scales="free")+
theme(legend.direction = "vertical",legend.position="right") +
guides(fill=guide_legend(ncol=1))+
labs(y= "Mean Relative Abundance")+
theme(plot.title = element_text(size = rel(1.5), face="bold"),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text=element_text(size=13, face = "bold"),
axis.line.x = element_blank(),
axis.text.x = element_text(angle = 90, hjust = 0.5, vjust=0.5),
#axis.ticks.x = element_blank(),
axis.title.x = element_blank(),
axis.title =element_text(size=15,face="bold"),
legend.text=element_text(size = 12),
legend.title = element_text(size=13, face = "bold"),
panel.grid = element_blank(),
panel.background = element_blank(),
strip.background = element_blank(),
strip.text.x = element_text(size = 14, face = "bold"),
panel.border = element_rect(colour = "black", fill = NA,linewidth= 0.2))+
scale_y_continuous(expand = c(0,0))+ guides(x="axis_nested")
com.sp.plot
displayAvailablePalette(color="white")
#x_cols <- rep(hue_pal()(length(unique(interaction(aob.sp.df$Date, aob.sp.df$Irrigation)))))
#aob.sp.df$Date <- factor(aob.sp.df$Date, levels = unique(aob.sp.df$Date))
com.sp.plot <- ggplot(com.sp.df, aes(x=interaction(Date, Irrigation), y=Mean, fill=Clade)) +
geom_bar(aes(), stat="identity", position="fill") +
scale_fill_manual(legend, values=PairedColor12Steps)+
facet_nested(~Type+Treatment, nest_line = element_line(linetype = 1), scales="free")+
theme(legend.direction = "vertical",legend.position="right") +
guides(fill=guide_legend(ncol=1))+
labs(y= "Mean Relative Abundance")+
theme(plot.title = element_text(size = rel(1.5), face="bold"),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text=element_text(size=13, face = "bold"),
axis.line.x = element_blank(),
axis.text.x = element_text(angle = 90, hjust = 0.5, vjust=0.5),
#axis.ticks.x = element_blank(),
axis.title.x = element_blank(),
axis.title =element_text(size=15,face="bold"),
legend.text=element_text(size = 12),
legend.title = element_text(size=13, face = "bold"),
panel.grid = element_blank(),
panel.background = element_blank(),
strip.background = element_blank(),
strip.text.x = element_text(size = 14, face = "bold"),
panel.border = element_rect(colour = "black", fill = NA,linewidth= 0.2))+
scale_y_continuous(expand = c(0,0))+ guides(x="axis_nested")
com.sp.plot
View(com.sp.df)
# merge taxa by species
com.sp <- tax_glom(com.rare.min.physeq, taxrank = "Species", NArm = F)
com.sp.ra <- transform_sample_counts(com.sp, function(x) x/sum(x))
sample_data(com.sp.ra)
#detach(package:plyr)
com.sp.df <- psmelt(com.sp.ra) %>%
group_by(var2, Type, Date, Treatment, Irrigation, Clade, Species) %>%
summarize(Mean = mean(Abundance)) %>%
arrange(-Mean)
com.sp.df$Type <- factor(com.sp.df$Type, levels = c("BS", "RS"),
labels = c("Bulk Soil", "Rhizosphere"))
com.sp.df$Treatment <- factor(com.sp.df$Treatment, levels = c("D", "K", "M"),
labels = c("Biodynamic", "Conventional", "Mineral"))
legend <- "Comammox Taxa"
library(scales)
#x_cols <- rep(hue_pal()(length(unique(interaction(aob.sp.df$Date, aob.sp.df$Irrigation)))))
#aob.sp.df$Date <- factor(aob.sp.df$Date, levels = unique(aob.sp.df$Date))
com.sp.plot <- ggplot(com.sp.df, aes(x=interaction(Date, Irrigation), y=Mean, fill=Clade)) +
geom_bar(aes(), stat="identity", position="fill") +
scale_fill_manual(legend, values=PairedColor12Steps)+
facet_nested(~Type+Treatment, nest_line = element_line(linetype = 1), scales="free")+
theme(legend.direction = "vertical",legend.position="right") +
guides(fill=guide_legend(ncol=1))+
labs(y= "Mean Relative Abundance")+
theme(plot.title = element_text(size = rel(1.5), face="bold"),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text=element_text(size=13, face = "bold"),
axis.line.x = element_blank(),
axis.text.x = element_text(angle = 90, hjust = 0.5, vjust=0.5),
#axis.ticks.x = element_blank(),
axis.title.x = element_blank(),
axis.title =element_text(size=15,face="bold"),
legend.text=element_text(size = 12),
legend.title = element_text(size=13, face = "bold"),
panel.grid = element_blank(),
panel.background = element_blank(),
strip.background = element_blank(),
strip.text.x = element_text(size = 14, face = "bold"),
panel.border = element_rect(colour = "black", fill = NA,linewidth= 0.2))+
scale_y_continuous(expand = c(0,0))+ guides(x="axis_nested")
com.sp.plot
#x_cols <- rep(hue_pal()(length(unique(interaction(aob.sp.df$Date, aob.sp.df$Irrigation)))))
#aob.sp.df$Date <- factor(aob.sp.df$Date, levels = unique(aob.sp.df$Date))
com.sp.plot <- ggplot(com.sp.df, aes(x=interaction(Date, Irrigation), y=Mean)) +
geom_bar(aes(fill=Species), stat="identity", position="fill") +
scale_fill_manual(legend, values=PairedColor12Steps)+
facet_nested(~Type+Treatment, nest_line = element_line(linetype = 1), scales="free")+
theme(legend.direction = "vertical",legend.position="right") +
guides(fill=guide_legend(ncol=1))+
labs(y= "Mean Relative Abundance")+
theme(plot.title = element_text(size = rel(1.5), face="bold"),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text=element_text(size=13, face = "bold"),
axis.line.x = element_blank(),
axis.text.x = element_text(angle = 90, hjust = 0.5, vjust=0.5),
#axis.ticks.x = element_blank(),
axis.title.x = element_blank(),
axis.title =element_text(size=15,face="bold"),
legend.text=element_text(size = 12),
legend.title = element_text(size=13, face = "bold"),
panel.grid = element_blank(),
panel.background = element_blank(),
strip.background = element_blank(),
strip.text.x = element_text(size = 14, face = "bold"),
panel.border = element_rect(colour = "black", fill = NA,linewidth= 0.2))+
scale_y_continuous(expand = c(0,0))+ guides(x="axis_nested")
com.sp.plot
#x_cols <- rep(hue_pal()(length(unique(interaction(aob.sp.df$Date, aob.sp.df$Irrigation)))))
#aob.sp.df$Date <- factor(aob.sp.df$Date, levels = unique(aob.sp.df$Date))
com.sp.plot <- ggplot(com.sp.df, aes(x=interaction(Date, Irrigation), y=Mean)) +
geom_bar(aes(fill=Species), stat="identity", position="fill") +
scale_fill_manual(legend, values=SteppedSequential5Steps)+
facet_nested(~Type+Treatment, nest_line = element_line(linetype = 1), scales="free")+
theme(legend.direction = "vertical",legend.position="right") +
guides(fill=guide_legend(ncol=1))+
labs(y= "Mean Relative Abundance")+
theme(plot.title = element_text(size = rel(1.5), face="bold"),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text=element_text(size=13, face = "bold"),
axis.line.x = element_blank(),
axis.text.x = element_text(angle = 90, hjust = 0.5, vjust=0.5),
#axis.ticks.x = element_blank(),
axis.title.x = element_blank(),
axis.title =element_text(size=15,face="bold"),
legend.text=element_text(size = 12),
legend.title = element_text(size=13, face = "bold"),
panel.grid = element_blank(),
panel.background = element_blank(),
strip.background = element_blank(),
strip.text.x = element_text(size = 14, face = "bold"),
panel.border = element_rect(colour = "black", fill = NA,linewidth= 0.2))+
scale_y_continuous(expand = c(0,0))+ guides(x="axis_nested")
com.sp.plot
#x_cols <- rep(hue_pal()(length(unique(interaction(aob.sp.df$Date, aob.sp.df$Irrigation)))))
#aob.sp.df$Date <- factor(aob.sp.df$Date, levels = unique(aob.sp.df$Date))
com.sp.plot <- ggplot(com.sp.df, aes(x=interaction(Date, Irrigation), y=Mean, group=Clade)) +
geom_bar(aes(fill=Species), stat="identity", position="fill") +
scale_fill_manual(legend, values=SteppedSequential5Steps)+
facet_nested(~Type+Treatment, nest_line = element_line(linetype = 1), scales="free")+
theme(legend.direction = "vertical",legend.position="right") +
guides(fill=guide_legend(ncol=1))+
labs(y= "Mean Relative Abundance")+
theme(plot.title = element_text(size = rel(1.5), face="bold"),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text=element_text(size=13, face = "bold"),
axis.line.x = element_blank(),
axis.text.x = element_text(angle = 90, hjust = 0.5, vjust=0.5),
#axis.ticks.x = element_blank(),
axis.title.x = element_blank(),
axis.title =element_text(size=15,face="bold"),
legend.text=element_text(size = 12),
legend.title = element_text(size=13, face = "bold"),
panel.grid = element_blank(),
panel.background = element_blank(),
strip.background = element_blank(),
strip.text.x = element_text(size = 14, face = "bold"),
panel.border = element_rect(colour = "black", fill = NA,linewidth= 0.2))+
scale_y_continuous(expand = c(0,0))+ guides(x="axis_nested")
com.sp.plot
#x_cols <- rep(hue_pal()(length(unique(interaction(aob.sp.df$Date, aob.sp.df$Irrigation)))))
#aob.sp.df$Date <- factor(aob.sp.df$Date, levels = unique(aob.sp.df$Date))
com.sp.plot <- ggplot(com.sp.df, aes(x=interaction(Date, Irrigation), y=Mean)) +
geom_bar(aes(fill=Species), stat="identity", position="fill") +
scale_fill_manual(legend, values=SteppedSequential5Steps)+
facet_nested(~Type+Treatment, nest_line = element_line(linetype = 1), scales="free")+
theme(legend.direction = "vertical",legend.position="right") +
guides(fill=guide_legend(ncol=1))+
labs(y= "Mean Relative Abundance")+
theme(plot.title = element_text(size = rel(1.5), face="bold"),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text=element_text(size=13, face = "bold"),
axis.line.x = element_blank(),
axis.text.x = element_text(angle = 90, hjust = 0.5, vjust=0.5),
#axis.ticks.x = element_blank(),
axis.title.x = element_blank(),
axis.title =element_text(size=15,face="bold"),
legend.text=element_text(size = 12),
legend.title = element_text(size=13, face = "bold"),
panel.grid = element_blank(),
panel.background = element_blank(),
strip.background = element_blank(),
strip.text.x = element_text(size = 14, face = "bold"),
panel.border = element_rect(colour = "black", fill = NA,linewidth= 0.2))+
scale_y_continuous(expand = c(0,0))+ guides(x="axis_nested")
com.sp.plot
#########################################################################################
# COMAMMOX Community Composition
########################################################################################
# Phyloseq object of rarefied data and unrarefied data:
# 1. rarefied data
com.rare.min.physeq
tax_table(com.rare.min.physeq)
# merge taxa by species
com.sp <- tax_glom(com.rare.min.physeq, taxrank = "Species", NArm = F)
com.sp.ra <- transform_sample_counts(com.sp, function(x) x/sum(x))
sample_data(com.sp.ra)
#detach(package:plyr)
com.sp.df <- psmelt(com.sp.ra) %>%
group_by(var2, Type, Date, Treatment, Irrigation, Clade, Species) %>%
summarize(Mean = mean(Abundance)) %>%
arrange(-Mean)
View(com.sp.df)
com.sp.df$Type <- factor(com.sp.df$Type, levels = c("BS", "RS"),
labels = c("Bulk Soil", "Rhizosphere"))
com.sp.df$Treatment <- factor(com.sp.df$Treatment, levels = c("D", "K", "M"),
labels = c("Biodynamic", "Conventional", "Mineral"))
str(com.sp.df)
com.sp.df$Species
View(com.sp.df)

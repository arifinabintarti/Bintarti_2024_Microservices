ax2.scores.uwUF.rh <- aob.rh_pcoa.uwUF$points[,2]
# 5. calculate percent variance explained, then add to plot
aob.meta.rh <- aob.meta.df.sub[120:191,]
# Bray-curtis - Rhizosphere :
ax1.rh <- aob.rh_pcoa_bc$eig[1]/sum(aob.rh_pcoa_bc$eig)
ax2.rh <- aob.rh_pcoa_bc$eig[2]/sum(aob.rh_pcoa_bc$eig)
aob.map.pcoa.rh <- cbind(aob.meta.rh,ax1.scores.rh,ax2.scores.rh)
# Jaccard - Rhizosphere :
ax1.j.rh <- aob.rh_pcoa_jac$eig[1]/sum(aob.rh_pcoa_jac$eig)
ax2.j.rh <- aob.rh_pcoa_jac$eig[2]/sum(aob.rh_pcoa_jac$eig)
aob.map.pcoa.j.rh <- cbind(aob.meta.rh,ax1.scores.j.rh,ax2.scores.j.rh)
# Weighted UniFrac - Rhizosphere :
ax1.wUF.rh <- aob.rh_pcoa_wUF$eig[1]/sum(aob.rh_pcoa_wUF$eig)
ax2.wUF.rh <- aob.rh_pcoa_wUF$eig[2]/sum(aob.rh_pcoa_wUF$eig)
aob.map.pcoa.wUF.rh <- cbind(aob.meta.rh,ax1.scores.wUF.rh,ax2.scores.wUF.rh)
# Unweighted UniFrac - Rhizosphere :
ax1.uwUF.rh <- aob.rh_pcoa.uwUF$eig[1]/sum(aob.rh_pcoa.uwUF$eig)
ax2.uwUF.rh <- aob.rh_pcoa.uwUF$eig[2]/sum(aob.rh_pcoa.uwUF$eig)
aob.map.pcoa.uwUF.rh <- cbind(aob.meta.rh,ax1.scores.uwUF.rh,ax2.scores.uwUF.rh)
# A. Bray-Curtis - Bulk Soil :
set.seed(13)
aob.adonis.bulk <- adonis2(aob.bulk_dist_bc ~ Irrigation*Treatment*Date, data=aob.meta.bulk,
permutation=999,
method="bray",
strata = NULL) # only treatment is significant
aob.adonis.bulk
STR(aob.meta.bulk)
str(aob.meta.bulk)
set.seed(13)
perm = how(nperm = 999,
within = Within(type="free"),
plots = with(aob.meta.bulk, Plots(strata=Treatment, type="free")),
blocks = aob.meta.bulk$Date)
set.seed(13)
aob.adonis.bulk.irri2 <- adonis2(aob.bulk_dist_bc ~ Irrigation*Treatment, data=aob.meta.bulk,
permutation=perm,method="bray") # not significant
aob.adonis.bulk.irri2
set.seed(13)
aob.adonis.bulk.irri2 <- adonis2(aob.bulk_dist_bc ~ Irrigation*Treatment*Date, data=aob.meta.bulk,
permutation=perm,method="bray") # not significant
set.seed(13)
perm = how(nperm = 999,
within = Within(type="free"),
plots = with(aob.meta.bulk, Plots(strata=Date, type="free")))
set.seed(13)
aob.adonis.bulk.irri2 <- adonis2(aob.bulk_dist_bc ~ Irrigation*Treatment, data=aob.meta.bulk,
permutation=perm,method="bray") # not significant
# SET THE WORKING DIRECTORY
setwd('/Users/arifinabintarti/Documents/France/microservices/030423_AOA_out/AOA.ASV-analysis')
setwd('D:/Fina/INRAE_Project/microservices/030423_AOA_out/AOA.ASV-analysis')
wd <- print(getwd())
# load the asv table
aoa.asv <- read.table('annotated.AOA.ASVs.counts.tsv', sep='\t', header=T, row.names = 1, check.names = FALSE)
dim(aoa.asv) # 646  192
sort(rowSums(aoa.asv, na.rm = FALSE, dims = 1), decreasing = F) # there are no asv that does not exist in at least one sample.
# load the taxonomy table
setwd('/Users/arifinabintarti/Documents/France/microservices/030423_AOA_out/')
setwd('D:/Fina/INRAE_Project/microservices/030423_AOA_out/')
aoa.tax <- read.table("besthit.diamond.output.curateddb.AOA.ASVs.edited.csv", sep = ';', header=T)
dim(aoa.tax) # 646
# load the metadata
setwd('/Users/arifinabintarti/Documents/France/microservices/')
setwd('D:/Fina/INRAE_Project/microservices/')
meta_micro <- read.csv("meta_microservices.csv")
# load phylogenetic tree (nwk file)
setwd('D:/Fina/INRAE_Project/microservices/030423_AOA_out/AOA-rooted-tree/')
AOA_rooted_tree <- ape::read.tree("tree.nwk")
AOA_rooted_tree
############################################################################
# rarefaction curve
set.seed(13)
rarecurve(t(aoa.asv), step=50, cex=0.5, lwd=2, ylab="ASV", label=F)
re_order <- match(rownames(meta_micro), colnames(aoa.asv))
aoa.asv.ord  <- aoa.asv[ ,re_order]
aoa.asv.physeq = otu_table(aoa.asv.ord, taxa_are_rows = TRUE) # asv table
sample_names(aoa.asv.physeq)
# adding "S" for sample names to avoid possible problem later on
sample_names(aoa.asv.physeq) <- paste0("S", sample_names(aoa.asv.physeq))
# phyloseq object of the taxonomy table
aoa.tax <- column_to_rownames(aoa.tax, var = "ASVid")
#row.names(aoa.tax) <- aoa.tax$ASVid
aoa.tax.physeq = tax_table(as.matrix(aoa.tax)) # taxonomy table
# phyloseq object of the metadata
meta_micro$Date <- factor(meta_micro$Date, levels = c("4/28/22", "06/01/2022", "07/05/2022", "7/20/22", "9/13/22"),
labels = c("04-28-22", "06-01-22", "07-05-22", "07-20-22", "09-13-22"))
rownames(meta_micro) <- sample_names(aoa.asv.physeq)
aoa.meta.physeq <- sample_data(meta_micro)# meta data
sample_names(aoa.meta.physeq)
# read the rooted tree
setwd('D:/Fina/INRAE_Project/microservices/030423_AOA_out/AOA-rooted-tree/')
AOA_rooted_tree <- ape::read.tree("tree.nwk")
# make phyloseq object
aoa.physeq <- merge_phyloseq(aoa.asv.physeq,aoa.tax.physeq,aoa.meta.physeq,AOA_rooted_tree)
aoa.physeq
sample_data(aoa.physeq)$SampleID <- paste0("S", sample_data(aoa.physeq)$SampleID)
sample_data(aoa.physeq)
# run the ggrare function attached in the file "generating_rarecurve.r"
aoa.rare <- ggrare(aoa.physeq, step = 1, color = "Type", label = "SampleID", se = FALSE)
# rarefy to minimum sequencing depth (minimum reads = 3832 reads)
set.seed(13)
aoa.rare.min.physeq <- rarefy_even_depth(aoa.physeq, sample.size = min(sample_sums(aoa.physeq)),
rngseed = 13, replace = FALSE, trimOTUs = TRUE, verbose = TRUE)
aoa.rare.min.physeq
sort(sample_sums(aoa.rare.min.physeq), decreasing = F) # 54 OTUs were removed because they are no longer present in any sample after random subsampling
# no sample removed
sort(rowSums(otu_table(aoa.rare.min.physeq), na.rm = FALSE, dims = 1), decreasing = F)
colSums(otu_table(aoa.rare.min.physeq))
aoarare.asv.df <- as.data.frame(otu_table(aoa.rare.min.physeq))
dim(aoarare.asv.df) # 592 ASVs, 192 samples
aoarare.asv.df_pa <- 1*(aoarare.asv.df>0)
aoa.s <- specnumber(aoarare.asv.df, MARGIN = 2) # richness
aoa.richness <- as.data.frame(aoa.s)
aoa.h <- diversity(t(aoarare.asv.df), index = 'shannon') # Shannon index
aoa.shannon <- as.data.frame(aoa.h)
aoa.d <- diversity(t(aoarare.asv.df), index = 'simpson') # Simpson index
aoa.simpson <- as.data.frame(aoa.d)
aoa.inv.d <- diversity(t(aoarare.asv.df), index = 'invsimpson')
aoa.meta.df <- data.frame(meta_micro)
aoa.meta.df$Richness <- aoa.s
aoa.meta.df$Shannon <- aoa.h
aoa.meta.df$Simpson <- aoa.d
aoa.meta.df$InvSimpson <- aoa.inv.d
#aob.min.meta.df$Date  <- as.Date(aob.min.meta.df$Date , "%m/%d/%Y")
str(aoa.meta.df)
aoa.meta.df$Type <- factor(aoa.meta.df$Type, levels = c("BS", "RS"),
labels = c("Bulk Soil", "Rhizosphere"))
aoa.meta.df$Treatment <- factor(aoa.meta.df$Treatment, levels = c("D", "K", "M"),
labels = c("Biodynamic", "Conventional", "Mineral fertilized"))
aoa.meta.df$SampleID<-as.factor(aoa.meta.df$SampleID)
aoa.meta.df$PlotID<-as.factor(aoa.meta.df$PlotID)
aoa.meta.df$Irrigation<-as.factor(aoa.meta.df$Irrigation)
# tidy up the data frame
aoa.meta.df.tidy <- aoa.meta.df %>%
group_by(Irrigation, Treatment, Date, Type, var2,var3) %>%
summarize(Mean.Rich=mean(Richness),
Mean.Sha=mean(Shannon),
Mean.Simp=mean(Simpson),
Mean.invsimp=mean(InvSimpson))
str(aoa.meta.df.tidy)
# Bray-Curtis - Bulk Soil :
aoarare.asv.df
aoa.asv.bulk <- aoarare.asv.df[,1:120]
aoa.asv.bulk1 <- aoa.asv.bulk[rowSums(aoa.asv.bulk)>0,]
sort(rowSums(aoa.asv.bulk1, na.rm = FALSE, dims = 1), decreasing = FALSE)
aoa.bulk_dist_bc <- vegdist(t(aoa.asv.bulk1), method = "bray")
# jaccard - Bulk Soil :
aoa.bulk_dist_jac <- vegdist(t(aoa.asv.bulk1), binary = TRUE, method = "jaccard")
# Weighted UniFrac (rarefied) - Bulk Soil:
aoa.physeq_bulk <- subset_samples(aoa.rare.min.physeq, Type=="BS")
aoa.physeq_bulk1 <- prune_taxa(taxa_sums(aoa.physeq_bulk)>0, aoa.physeq_bulk)
aoa.physeq_bulk1
sort(taxa_sums(aoa.physeq_bulk1), decreasing =F) #checking
aoa.bulk_dist_wUF <- UniFrac(aoa.physeq_bulk1, weighted=TRUE, normalized = TRUE)
aoa.bulk_dist_wUF
# Unweighted UniFrac (rarefied) -  Bulk Soil:
aoa.bulk_dist_uwUF <- UniFrac(aoa.physeq_bulk1, weighted=FALSE, normalized = TRUE)
aoa.bulk_dist_uwUF
# Bray-Curtis - Bulk Soil:
aoa.bulk_pcoa_bc <- cmdscale(aoa.bulk_dist_bc, eig=T)
# Jaccard - Bulk Soil:
aoa.bulk_pcoa_jac <- cmdscale(aoa.bulk_dist_jac, eig=T)
# Weighted UniFrac - Bulk Soil:
aoa.bulk_pcoa_wUF <- cmdscale(aoa.bulk_dist_wUF, eig=T)
# Unweighted UniFrac - Bulk Soil:
aoa.bulk_pcoa.uwUF <- cmdscale(aoa.bulk_dist_uwUF, eig=T)
# Bray-Curtis - Bulk Soil:
ax1.scores.bulk <- aoa.bulk_pcoa_bc$points[,1]
ax2.scores.bulk <- aoa.bulk_pcoa_bc$points[,2]
# Jaccard - Bulk Soil:
ax1.scores.j.bulk <- aoa.bulk_pcoa_jac$points[,1]
ax2.scores.j.bulk <- aoa.bulk_pcoa_jac$points[,2]
# Weighted UniFrac - Bulk Soil:
ax1.scores.wUF.bulk <- aoa.bulk_pcoa_wUF$points[,1]
ax2.scores.wUF.bulk <- aoa.bulk_pcoa_wUF$points[,2]
# Unweighted UniFrac - Bulk Soil:
ax1.scores.uwUF.bulk <- aoa.bulk_pcoa.uwUF$points[,1]
ax2.scores.uwUF.bulk <- aoa.bulk_pcoa.uwUF$points[,2]
aoa.meta.bulk <- aoa.meta.df[1:120,]
# Bray-curtis - Bulk Soil:
ax1.bulk <- aoa.bulk_pcoa_bc$eig[1]/sum(aoa.bulk_pcoa_bc$eig)
ax2.bulk <- aoa.bulk_pcoa_bc$eig[2]/sum(aoa.bulk_pcoa_bc$eig)
aoa.map.pcoa.bulk <- cbind(aoa.meta.bulk,ax1.scores.bulk,ax2.scores.bulk)
# Jaccard - Bulk Soil:
ax1.j.bulk <- aoa.bulk_pcoa_jac$eig[1]/sum(aoa.bulk_pcoa_jac$eig)
ax2.j.bulk <- aoa.bulk_pcoa_jac$eig[2]/sum(aoa.bulk_pcoa_jac$eig)
aoa.map.pcoa.j.bulk <- cbind(aoa.meta.bulk,ax1.scores.j.bulk,ax2.scores.j.bulk)
# Weighted UniFrac - Bulk Soil:
ax1.wUF.bulk <- aoa.bulk_pcoa_wUF$eig[1]/sum(aoa.bulk_pcoa_wUF$eig)
ax2.wUF.bulk <- aoa.bulk_pcoa_wUF$eig[2]/sum(aoa.bulk_pcoa_wUF$eig)
aoa.map.pcoa.wUF.bulk <- cbind(aoa.meta.bulk,ax1.scores.wUF.bulk,ax2.scores.wUF.bulk)
# Unweighted UniFrac - Bulk Soil:
ax1.uwUF.bulk <- aoa.bulk_pcoa.uwUF$eig[1]/sum(aoa.bulk_pcoa.uwUF$eig)
ax2.uwUF.bulk <- aoa.bulk_pcoa.uwUF$eig[2]/sum(aoa.bulk_pcoa.uwUF$eig)
aoa.map.pcoa.uwUF.bulk <- cbind(aoa.meta.bulk,ax1.scores.uwUF.bulk,ax2.scores.uwUF.bulk)
aoa.asv.rh <- aoarare.asv.df[,121:192]
aoa.asv.rh1 <- aoa.asv.rh[rowSums(aoa.asv.rh)>0,]
sort(rowSums(aoa.asv.rh1, na.rm = FALSE, dims = 1), decreasing = FALSE)
dim(aoa.asv.rh1)
aoa.rh_dist_bc <- vegdist(t(aoa.asv.rh1), method = "bray")
# jaccard - Rhizosphere :
aoa.rh_dist_jac <- vegdist(t(aoa.asv.rh1), binary = TRUE, method = "jaccard")
# Weighted UniFrac (rarefied) - Rhizosphere :
aoa.physeq_rh <- subset_samples(aoa.rare.min.physeq, Type=="RS")
aoa.physeq_rh1 <- prune_taxa(taxa_sums(aoa.physeq_rh)>0, aoa.physeq_rh)
aoa.physeq_rh1
sort(taxa_sums(aoa.physeq_rh1), decreasing =F) #checking
aoa.rh_dist_wUF <- UniFrac(aoa.physeq_rh1, weighted=TRUE, normalized = TRUE)
aoa.rh_dist_wUF
# Unweighted UniFrac (rarefied) -  Rhizosphere :
aoa.rh_dist_uwUF <- UniFrac(aoa.physeq_rh1, weighted=FALSE, normalized = TRUE)
aoa.rh_dist_uwUF
# 2. CMD/classical multidimensional scaling (MDS) of a data matrix. Also known as principal coordinates analysis
# Bray-Curtis - Rhizosphere :
aoa.rh_pcoa_bc <- cmdscale(aoa.rh_dist_bc, eig=T)
# Jaccard - Rhizosphere :
aoa.rh_pcoa_jac <- cmdscale(aoa.rh_dist_jac, eig=T)
# Weighted UniFrac - Rhizosphere :
aoa.rh_pcoa_wUF <- cmdscale(aoa.rh_dist_wUF, eig=T)
# Unweighted UniFrac - Rhizosphere :
aoa.rh_pcoa.uwUF <- cmdscale(aoa.rh_dist_uwUF, eig=T)
# 3. scores of PC1 and PC2
# Bray-Curtis - Rhizosphere :
ax1.scores.rh <- aoa.rh_pcoa_bc$points[,1]
ax2.scores.rh <- aoa.rh_pcoa_bc$points[,2]
# Jaccard - Rhizosphere :
ax1.scores.j.rh <- aoa.rh_pcoa_jac$points[,1]
ax2.scores.j.rh <- aoa.rh_pcoa_jac$points[,2]
# Weighted UniFrac - Rhizosphere :
ax1.scores.wUF.rh <- aoa.rh_pcoa_wUF$points[,1]
ax2.scores.wUF.rh <- aoa.rh_pcoa_wUF$points[,2]
# Unweighted UniFrac - Rhizosphere :
ax1.scores.uwUF.rh <- aoa.rh_pcoa.uwUF$points[,1]
ax2.scores.uwUF.rh <- aoa.rh_pcoa.uwUF$points[,2]
#env_fit <- envfit(otu_pcoa, env, na.rm=TRUE)
# 5. calculate percent variance explained, then add to plot
aoa.meta.rh <- aoa.meta.df[121:192,]
# Bray-curtis - Rhizosphere :
ax1.rh <- aoa.rh_pcoa_bc$eig[1]/sum(aoa.rh_pcoa_bc$eig)
ax2.rh <- aoa.rh_pcoa_bc$eig[2]/sum(aoa.rh_pcoa_bc$eig)
aoa.map.pcoa.rh <- cbind(aoa.meta.rh,ax1.scores.rh,ax2.scores.rh)
# Jaccard - Rhizosphere :
ax1.j.rh <- aoa.rh_pcoa_jac$eig[1]/sum(aoa.rh_pcoa_jac$eig)
ax2.j.rh <- aoa.rh_pcoa_jac$eig[2]/sum(aoa.rh_pcoa_jac$eig)
aoa.map.pcoa.j.rh <- cbind(aoa.meta.rh,ax1.scores.j.rh,ax2.scores.j.rh)
# Weighted UniFrac - Rhizosphere :
ax1.wUF.rh <- aoa.rh_pcoa_wUF$eig[1]/sum(aoa.rh_pcoa_wUF$eig)
ax2.wUF.rh <- aoa.rh_pcoa_wUF$eig[2]/sum(aoa.rh_pcoa_wUF$eig)
aoa.map.pcoa.wUF.rh <- cbind(aoa.meta.rh,ax1.scores.wUF.rh,ax2.scores.wUF.rh)
# Unweighted UniFrac - Rhizosphere :
ax1.uwUF.rh <- aoa.rh_pcoa.uwUF$eig[1]/sum(aoa.rh_pcoa.uwUF$eig)
ax2.uwUF.rh <- aoa.rh_pcoa.uwUF$eig[2]/sum(aoa.rh_pcoa.uwUF$eig)
aoa.map.pcoa.uwUF.rh <- cbind(aoa.meta.rh,ax1.scores.uwUF.rh,ax2.scores.uwUF.rh)
set.seed(13)
perm = how(nperm = 999, within = Within(type="free"),
plots = with(aoa.meta.bulk, Plots(strata=Treatment, type="free")),
blocks = aoa.meta.bulk$Date)
set.seed(13)
aoa.adonis.bulk.irri2 <- adonis2(aoa.bulk_dist_bc ~ Irrigation*Treatment, data=aoa.meta.bulk,
permutation=perm,method="bray") # not significant
aoa.adonis.bulk.irri2
set.seed(13)
aoa.adonis.bulk.irri2 <- adonis2(aoa.bulk_dist_bc ~ Irrigation*Treatment*Date, data=aoa.meta.bulk,
permutation=perm,method="bray") # not significant
aoa.adonis.bulk.irri2
set.seed(13)
perm = how(nperm = 999, within = Within(type="free"),
plots = with(aoa.meta.bulk, Plots(strata=Date, type="free")))
set.seed(13)
aoa.adonis.bulk.irri2 <- adonis2(aoa.bulk_dist_bc ~ Irrigation*Treatment, data=aoa.meta.bulk,
permutation=perm,method="bray") # not significant
aoa.adonis.bulk.irri2
# SET THE WORKING DIRECTORY
setwd('/Users/arifinabintarti/Documents/France/microservices/090623_COM_out/COM.ASV-analysis')
setwd('D:/Fina/INRAE_Project/microservices/090623_COM_out/COM.ASV-analysis')
wd <- print(getwd())
# load the asv table
com.asv <- read.table('annotated.COM.ASVs.counts.tsv', sep='\t', header=T, row.names = 1, check.names = FALSE)
dim(com.asv) # 686 192
# remove the bad sample (sample # 26) from the OTU table
com.asv.sub <- com.asv[, -which(names(com.asv) == "26" )]
sort(rowSums(com.asv.sub, na.rm = FALSE, dims = 1), decreasing = FALSE)
dim(com.asv.sub)
# load the taxonomy table
setwd('/Users/arifinabintarti/Documents/France/microservices/090623_COM_out/')
setwd('D:/Fina/INRAE_Project/microservices/090623_COM_out/')
com.tax <- read.table("besthit.diamond.output.curateddb.COM.ASVs.edited.csv", sep = ';', header=T)
dim(com.tax) # 680
# load the metadata
setwd('/Users/arifinabintarti/Documents/France/microservices/')
setwd('D:/Fina/INRAE_Project/microservices/')
meta_micro <- read.csv("meta_microservices.csv")
# remove the bad sample (sample # 26) from the metadata
meta_micro_sub <- meta_micro[-26,]
# load phylogenetic tree (nwk file)
setwd('D:/Fina/INRAE_Project/microservices/090623_COM_out/COM-rooted-tree/')
COM_rooted_tree <- ape::read.tree("tree.nwk")
############################################################################
# rarefaction curve
set.seed(13)
rarecurve(t(com.asv), step=50, cex=0.5, lwd=2, ylab="ASV", label=F)
re_order <- match(rownames(meta_micro_sub), colnames(com.asv.sub))
com.asv.ord  <- com.asv.sub[ ,re_order]
com.asv.physeq = otu_table(com.asv.ord, taxa_are_rows = TRUE) # asv table
sample_names(com.asv.physeq)
# adding "S" for sample names to avoid possible problem later on
sample_names(com.asv.physeq) <- paste0("S", sample_names(com.asv.physeq))
# phyloseq object of the taxonomy table
com.tax <- column_to_rownames(com.tax, var = "ASVid")
#row.names(com.tax) <- com.tax$ASVid
com.tax.physeq = tax_table(as.matrix(com.tax)) # taxonomy table
# phyloseq object of the metadata
meta_micro_sub$Date <- factor(meta_micro_sub$Date, levels = c("4/28/22", "06/01/2022", "07/05/2022", "7/20/22", "9/13/22"),
labels = c("04-28-22", "06-01-22", "07-05-22", "07-20-22", "09-13-22"))
rownames(meta_micro_sub) <- sample_names(com.asv.physeq)
com.meta.physeq <- sample_data(meta_micro_sub)# meta data
sample_names(com.meta.physeq)
# read the rooted tree
setwd('D:/Fina/INRAE_Project/microservices/090623_COM_out/COM-rooted-tree/')
COM_rooted_tree <- ape::read.tree("tree.nwk")
# make phyloseq object
com.physeq <- merge_phyloseq(com.asv.physeq,com.tax.physeq,com.meta.physeq,COM_rooted_tree)
com.physeq # 653 taxa
sample_data(com.physeq)$SampleID <- paste0("S", sample_data(com.physeq)$SampleID)
sample_data(com.physeq)
# run the ggrare function attached in the file "generating_rarecurve.r"
com.rare <- ggrare(com.physeq, step = 1, color = "Type", label = "SampleID", se = FALSE)
# rarefy to minimum sequencing depth (minimum reads =  reads)
set.seed(333)
com.rare.min.physeq <- rarefy_even_depth(com.physeq, sample.size = 5242,
rngseed = 333, replace = FALSE, trimOTUs = TRUE, verbose = TRUE)
com.rare.min.physeq #632 taxa
sort(sample_sums(com.rare.min.physeq), decreasing = F) # 21 OTUs were removed because they are no longer present in any sample after random subsampling
# 1 sample removed (S52)
sort(rowSums(otu_table(com.rare.min.physeq), na.rm = FALSE, dims = 1), decreasing = F)
# run the ggrare function attached in the file "generating_rarecurve.r"
com.rare.min <- ggrare(com.rare.min.physeq, step = 1, color = "Type", label = "SampleID", se = FALSE)
colSums(otu_table(com.rare.min.physeq))
com.rare.asv.df <- as.data.frame(otu_table(com.rare.min.physeq))
dim(com.rare.asv.df) # 632 ASVs, 190 samples
com.rare.asv.df_pa <- 1*(com.rare.asv.df>0)
com.s <- specnumber(com.rare.asv.df, MARGIN = 2) # richness
com.richness <- as.data.frame(com.s)
com.h <- diversity(t(com.rare.asv.df), index = 'shannon') # Shannon index
com.shannon <- as.data.frame(com.h)
com.d <- diversity(t(com.rare.asv.df), index = 'simpson') # Simpson index
com.simpson <- as.data.frame(com.d)
com.inv.d <- diversity(t(com.rare.asv.df), index = 'invsimpson')
# 1. Richness
# Line plot of COM richness
meta_micro_sub2 <- meta_micro_sub %>% filter(SampleID != "52")
com.meta.df <- data.frame(meta_micro_sub2)
com.meta.df$Richness <- com.s
com.meta.df$Shannon <- com.h
com.meta.df$Simpson <- com.d
com.meta.df$InvSimpson <- com.inv.d
#com.min.meta.df$Date  <- as.Date(com.meta.df$Date , "%m/%d/%Y")
str(com.meta.df)
com.meta.df$Type <- factor(com.meta.df$Type, levels = c("BS", "RS"),
labels = c("Bulk Soil", "Rhizosphere"))
com.meta.df$Treatment <- factor(com.meta.df$Treatment, levels = c("D", "K", "M"),
labels = c("Biodynamic", "Conventional", "Mineral fertilized"))
com.meta.df$SampleID<-as.factor(com.meta.df$SampleID)
com.meta.df$PlotID<-as.factor(com.meta.df$PlotID)
com.meta.df$Irrigation<-as.factor(com.meta.df$Irrigation)
# tidy up the data frame
com.meta.df.tidy <- com.meta.df %>%
group_by(Irrigation, Treatment, Date, Type, var2,var3) %>%
summarize(Mean.Rich=mean(Richness),
Mean.Sha=mean(Shannon),
Mean.Simp=mean(Simpson),
Mean.invsimp=mean(InvSimpson))
str(com.meta.df.tidy)
com.rare.asv.df
com.asv.bulk <- com.rare.asv.df[,1:118]
com.asv.bulk1 <- com.asv.bulk[rowSums(com.asv.bulk)>0,]
sort(rowSums(com.asv.bulk1, na.rm = FALSE, dims = 1), decreasing = FALSE)
com.bulk_dist_bc <- vegdist(t(com.asv.bulk1), method = "bray")
# jaccard - Bulk Soil :
com.bulk_dist_jac <- vegdist(t(com.asv.bulk1), binary = TRUE, method = "jaccard")
# Weighted UniFrac (rarefied) - Bulk Soil:
com.physeq_bulk <- subset_samples(com.rare.min.physeq, Type=="BS")
com.physeq_bulk1 <- prune_taxa(taxa_sums(com.physeq_bulk)>0, com.physeq_bulk)
com.physeq_bulk1
sort(taxa_sums(com.physeq_bulk1), decreasing =F) #checking
com.bulk_dist_wUF <- UniFrac(com.physeq_bulk1, weighted=TRUE, normalized = TRUE)
com.bulk_dist_wUF
# Unweighted UniFrac (rarefied) -  Bulk Soil:
com.bulk_dist_uwUF <- UniFrac(com.physeq_bulk1, weighted=FALSE, normalized = TRUE)
com.bulk_dist_uwUF
# 2. CMD/classical multidimensional scaling (MDS) of a data matrix. Also known as principal coordinates analysis
# Bray-Curtis - Bulk Soil:
com.bulk_pcoa_bc <- cmdscale(com.bulk_dist_bc, eig=T)
# Jaccard - Bulk Soil:
com.bulk_pcoa_jac <- cmdscale(com.bulk_dist_jac, eig=T)
# Weighted UniFrac - Bulk Soil:
com.bulk_pcoa_wUF <- cmdscale(com.bulk_dist_wUF, eig=T)
# Unweighted UniFrac - Bulk Soil:
com.bulk_pcoa.uwUF <- cmdscale(com.bulk_dist_uwUF, eig=T)
# 3. scores of PC1 and PC2
# Bray-Curtis - Bulk Soil:
ax1.scores.bulk <- com.bulk_pcoa_bc$points[,1]
ax2.scores.bulk <- com.bulk_pcoa_bc$points[,2]
# Jaccard - Bulk Soil:
ax1.scores.j.bulk <- com.bulk_pcoa_jac$points[,1]
ax2.scores.j.bulk <- com.bulk_pcoa_jac$points[,2]
# Weighted UniFrac - Bulk Soil:
ax1.scores.wUF.bulk <- com.bulk_pcoa_wUF$points[,1]
ax2.scores.wUF.bulk <- com.bulk_pcoa_wUF$points[,2]
# Unweighted UniFrac - Bulk Soil:
ax1.scores.uwUF.bulk <- com.bulk_pcoa.uwUF$points[,1]
ax2.scores.uwUF.bulk <- com.bulk_pcoa.uwUF$points[,2]
# 4. Envfit
env.com.bulk <- com.meta.df[1:118,c(13:19, 22,26:28)]
str(env.com.bulk)
env.com.bulk <- env.com.bulk %>% mutate_at(colnames(env.com.bulk), as.numeric)
# bray-curtis
set.seed(13)
env_fit.com.bc.bulk <- envfit(com.bulk_pcoa_bc, env.com.bulk, na.rm=TRUE)
env_fit.com.bc.bulk
# Jaccard
set.seed(13)
env_fit.com.jac <- envfit(com.bulk_pcoa_jac, env.com.bulk, na.rm=TRUE)
# Weighted UniFrac
set.seed(13)
env_fit.com.wuF <- envfit(com.bulk_pcoa_wUF, env.com.bulk, na.rm=TRUE)
# UnWeighted UniFrac
set.seed(13)
env_fit.com.uwuF <- envfit(com.bulk_pcoa.uwUF, env.com.bulk, na.rm=TRUE)
# 5. calculate percent variance explained, then add to plot
com.meta.bulk <- com.meta.df[1:118,]
# Bray-curtis - Bulk Soil:
ax1.bulk <- com.bulk_pcoa_bc$eig[1]/sum(com.bulk_pcoa_bc$eig)
ax2.bulk <- com.bulk_pcoa_bc$eig[2]/sum(com.bulk_pcoa_bc$eig)
com.map.pcoa.bulk <- cbind(com.meta.bulk,ax1.scores.bulk,ax2.scores.bulk)
# Jaccard - Bulk Soil:
ax1.j.bulk <- com.bulk_pcoa_jac$eig[1]/sum(com.bulk_pcoa_jac$eig)
ax2.j.bulk <- com.bulk_pcoa_jac$eig[2]/sum(com.bulk_pcoa_jac$eig)
com.map.pcoa.j.bulk <- cbind(com.meta.bulk,ax1.scores.j.bulk,ax2.scores.j.bulk)
# Weighted UniFrac - Bulk Soil:
ax1.wUF.bulk <- com.bulk_pcoa_wUF$eig[1]/sum(com.bulk_pcoa_wUF$eig)
ax2.wUF.bulk <- com.bulk_pcoa_wUF$eig[2]/sum(com.bulk_pcoa_wUF$eig)
com.map.pcoa.wUF.bulk <- cbind(com.meta.bulk,ax1.scores.wUF.bulk,ax2.scores.wUF.bulk)
# Unweighted UniFrac - Bulk Soil:
ax1.uwUF.bulk <- com.bulk_pcoa.uwUF$eig[1]/sum(com.bulk_pcoa.uwUF$eig)
ax2.uwUF.bulk <- com.bulk_pcoa.uwUF$eig[2]/sum(com.bulk_pcoa.uwUF$eig)
com.map.pcoa.uwUF.bulk <- cbind(com.meta.bulk,ax1.scores.uwUF.bulk,ax2.scores.uwUF.bulk)
#################################################################################################
# RHIZOSPHERE
# Bray-Curtis - Rhizosphere :
com.asv.rh <- com.rare.asv.df[,119:190]
com.asv.rh1 <- com.asv.rh[rowSums(com.asv.rh)>0,]
sort(rowSums(com.asv.rh1, na.rm = FALSE, dims = 1), decreasing = FALSE)
dim(com.asv.rh1)
com.rh_dist_bc <- vegdist(t(com.asv.rh1), method = "bray")
# jaccard - Rhizosphere :
com.rh_dist_jac <- vegdist(t(com.asv.rh1), binary = TRUE, method = "jaccard")
# Weighted UniFrac (rarefied) - Rhizosphere :
com.physeq_rh <- subset_samples(com.rare.min.physeq, Type=="RS")
com.physeq_rh1 <- prune_taxa(taxa_sums(com.physeq_rh)>0, com.physeq_rh)
com.physeq_rh1
sort(taxa_sums(com.physeq_rh1), decreasing =F) #checking
com.rh_dist_wUF <- UniFrac(com.physeq_rh1, weighted=TRUE, normalized = TRUE)
com.rh_dist_wUF
# Unweighted UniFrac (rarefied) -  Rhizosphere :
com.rh_dist_uwUF <- UniFrac(com.physeq_rh1, weighted=FALSE, normalized = TRUE)
com.rh_dist_uwUF
# Bray-Curtis - Rhizosphere :
com.rh_pcoa_bc <- cmdscale(com.rh_dist_bc, eig=T)
# Jaccard - Rhizosphere :
com.rh_pcoa_jac <- cmdscale(com.rh_dist_jac, eig=T)
# Weighted UniFrac - Rhizosphere :
com.rh_pcoa_wUF <- cmdscale(com.rh_dist_wUF, eig=T)
# Unweighted UniFrac - Rhizosphere :
com.rh_pcoa.uwUF <- cmdscale(com.rh_dist_uwUF, eig=T)
# 3. scores of PC1 and PC2
# Bray-Curtis - Rhizosphere :
ax1.scores.rh <- com.rh_pcoa_bc$points[,1]
ax2.scores.rh <- com.rh_pcoa_bc$points[,2]
# Jaccard - Rhizosphere :
ax1.scores.j.rh <- com.rh_pcoa_jac$points[,1]
ax2.scores.j.rh <- com.rh_pcoa_jac$points[,2]
# Weighted UniFrac - Rhizosphere :
ax1.scores.wUF.rh <- com.rh_pcoa_wUF$points[,1]
ax2.scores.wUF.rh <- com.rh_pcoa_wUF$points[,2]
# Unweighted UniFrac - Rhizosphere :
ax1.scores.uwUF.rh <- com.rh_pcoa.uwUF$points[,1]
ax2.scores.uwUF.rh <- com.rh_pcoa.uwUF$points[,2]
#env_fit <- envfit(otu_pcoa, env, na.rm=TRUE)
# 4. calculate percent variance explained, then add to plot
com.meta.rh <- com.meta.df[119:190,]
# Bray-curtis - Rhizosphere :
ax1.rh <- com.rh_pcoa_bc$eig[1]/sum(com.rh_pcoa_bc$eig)
ax2.rh <- com.rh_pcoa_bc$eig[2]/sum(com.rh_pcoa_bc$eig)
com.map.pcoa.rh <- cbind(com.meta.rh,ax1.scores.rh,ax2.scores.rh)
# Jaccard - Rhizosphere :
ax1.j.rh <- com.rh_pcoa_jac$eig[1]/sum(com.rh_pcoa_jac$eig)
ax2.j.rh <- com.rh_pcoa_jac$eig[2]/sum(com.rh_pcoa_jac$eig)
com.map.pcoa.j.rh <- cbind(com.meta.rh,ax1.scores.j.rh,ax2.scores.j.rh)
# Weighted UniFrac - Rhizosphere :
ax1.wUF.rh <- com.rh_pcoa_wUF$eig[1]/sum(com.rh_pcoa_wUF$eig)
ax2.wUF.rh <- com.rh_pcoa_wUF$eig[2]/sum(com.rh_pcoa_wUF$eig)
com.map.pcoa.wUF.rh <- cbind(com.meta.rh,ax1.scores.wUF.rh,ax2.scores.wUF.rh)
# Unweighted UniFrac - Rhizosphere :
ax1.uwUF.rh <- com.rh_pcoa.uwUF$eig[1]/sum(com.rh_pcoa.uwUF$eig)
ax2.uwUF.rh <- com.rh_pcoa.uwUF$eig[2]/sum(com.rh_pcoa.uwUF$eig)
com.map.pcoa.uwUF.rh <- cbind(com.meta.rh,ax1.scores.uwUF.rh,ax2.scores.uwUF.rh)
set.seed(13)
perm = how(nperm = 999, within = Within(type="free"),
plots = with(com.meta.bulk, Plots(strata=Date, type="free")))
set.seed(13)
com.adonis.bulk.irri2 <- adonis2(com.bulk_dist_bc ~ Irrigation*Treatment, data=com.meta.bulk,
permutation=perm,method="bray") # not significant
